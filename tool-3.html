<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.9">
  <title>AI Book Writer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="preload" href="modules/winbox.bundle.min.js" as="script">
  <link type="text/css" rel="stylesheet" href="standard.css"/>
  <style>
    body{
      background-color: #000;
    }
    .winbox.white{
      background:#fff
    }
    .winbox.white .wb-title{
      color:#000
    }.winbox.white .wb-control{
      filter:invert(1)
    }

    .winbox.dark{
      background:#414040
    }
    .winbox.dark .wb-body {
    /* set the width of window border via margin: */
    margin: 4px;
    color: #fff;
    background: #131820;
    }

    .winbox.dark .wb-title{
      color:#ebe7e7
    }.winbox.dark .wb-control{
      filter:invert(1)
    }

  </style>
</head>
<body>
  <!-- JS INCLUDES -->
  <script src__="modules/jquery-1.12.4.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="modules/winbox.bundle.min.js" async></script>
  
  <!-- My Stuff -->
  <script src="keys.js"></script>
  <script type="module">
    import * as call_ai from "/modules/call_ai.js"
    import * as idb from "/modules/IndexDB.js"
    import * as util from '/modules/utility.js';
    import {VectorDB} from "/modules/VectorDB.js";
    import {ConversationDB} from "/modules/ConversationDB.js";

    idb.SetDBName("ynbt-lite-ai_book_writer")
    window.call_ai = call_ai;
    window.idb = idb;
    window.util = util;
    window.VectorDB = new VectorDB();
    window.ConversationDB = new ConversationDB();

   
  </script>

  <!-- FUNCTIONS -->
  <script type_="module">
    function jsonDataExport()
    {
      const wnd1 = window.wnd_storySetup;
      const wnd2 = window.wnd_gen_storyPlotline;
      const wnd3 = window.wnd_expand_storyPlotline;
      var obj = 
      {
        opt_llm: $("#opt_llm")[0].value,
        inf_temperature: Number($("#inf_temperature")[0].value),
        inf_max_gen: Number($("#inf_max_gen")[0].value),
      
      
        tb_gen_storyplotline_genres:$("#tb_gen_storyplotline_genres")[0].value,
        tb_gen_storyplotline_timeperiod:$("#tb_gen_storyplotline_timeperiod")[0].value,
        tb_gen_storyplotline_locations:$("#tb_gen_storyplotline_locations")[0].value,
        ta_gen_storyplotline_initial_premise:$("#ta_gen_storyplotline_initial_premise")[0].value,

        ta_gen_storyplotline_result:$("#ta_gen_storyplotline_result")[0].value,

        ta_gen_storyplotpoint_source:$("#ta_gen_storyplotpoint_source")[0].value,
        ta_gen_storyplotpoint_result:$("#ta_gen_storyplotpoint_result")[0].value,
        tb_gen_storyplotpoint_style:$("#tb_gen_storyplotpoint_style")[0].value,

        wnd_storySetup : [wnd1.x, wnd1.y, wnd1.width, wnd1.height],
        wnd_gen_storyPlotline : [wnd2.x, wnd2.y, wnd2.width, wnd2.height],
        wnd_expand_storyPlotline : [wnd3.x, wnd3.y, wnd3.width, wnd3.height],
      }
      console.log(obj);
      window.util.saveAsFile("ynbt-ai_book_writer.json", obj, document);
    }
    function jsonDataImport(e)
    {
      try 
      {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = async (event) => {
          const contents = event.target.result;
          const data = JSON.parse(contents);
          
          const keys = Object.keys(data);
          keys.forEach(k=>{
            if(k.startsWith("wnd_"))
            {
              window[k].x = data[k][0];
              window[k].y = data[k][1];
              window[k].width = data[k][2];
              window[k].height = data[k][3];
              window[k].minimize(false);
              window[k].resize().move();
            }
            else
            {
              $(`#${k}`).val(data[k]);
            }
            
          })
        };

        reader.readAsText(file);
      } catch (error) {
        alert(error)
      }
    }
    
    function getStorySetupPrompt()
    {
      const p_template=
      `[STORY SETUP]
main female character name: MFC
main male character name: MMC
secondary female character name: SFC
secondary male character name: SMC
STORY NARRATIVE STRUCTURE: The Heroâ€™s Journey
STORY GENRE: ${document.getElementById('tb_gen_storyplotline_genres').value}
TIME PERIOD: ${document.getElementById('tb_gen_storyplotline_timeperiod').value}
LOCATIONS: ${document.getElementById('tb_gen_storyplotline_locations').value}
INITIAL PREMISE: ${document.getElementById('ta_gen_storyplotline_initial_premise').value}`;

      return p_template;
    }
    
    function getPromptPlotline(llmType="CGPT")
    {
      const storySetup = getStorySetupPrompt();

      if(llmType=="CGPT")
      {
        return `${storySetup}

[OUTPUT MARKDOWN SAMPLE]
# Title: this story suggested title
## Genre: this story genre
## Narative Structure Name: story narative structure name, such as introduction to the ordinary world.
### Plot Point Name - current story plot point catchy title
#### Plot Point Event catchy event title
write plot point story here.

[INSTRUCTION]
Write a VERY DETAILED PLOT POINT EVENTS for a story. 
Write the STRUCTURE of the story according to the STORY GENRE and NARRATIVE STRUCTURE. 
Write the PLOT POINTS of the story according to the STORY GENRE and NARRATIVE STRUCTURE. 
Devide the PLOT POINTS into several chapters.
Use OUTPUT MARKDOWN SAMPLE for output. 
Don't write anything else.`;
      }

      else{
        return `### Instruction:
${storySetup}

[SAMPLE OUTPUT]
* Story Title: write a very catchy title for the story.
* Story Structure List:
  + Plot Point Name: plot point name according STORY NARRATIVE STRUCTURE (such as introduction to the ordinary world).
    + Chapter Title: a very catchy title for this plot point.
      + Plot Point Story List: very detail stories about the events happened in the current story plot point.

Write your response following the [SAMPLE OUTPUT].
### Response:\n`;
      }
    }
    
    function getPromptExpandPlotline(llmType="CGPT")
    {
      const storySetup = getStorySetupPrompt();
      let plotPoint = document.getElementById("ta_gen_storyplotpoint_source").value;
      let storyTellingStyle = $("#tb_gen_storyplotpoint_style")[0].value;
      plotPoint = plotPoint.replaceAll(`\t`,``);
      const p_ll2= `### Instruction:
${storySetup}

[PLOT POINT TO EXPAND]
${plotPoint}

[STEPS TO EXPAND THE PLOT POINT]
Write a very detailed content and dialogues for [PLOT POINT TO EXPAND] in a "${storyTellingStyle}" style.
Describe the looks, feels, smells for the scenery or places in great detail.
Describe the characters feelings and actions in great details.
Always remember, SHOW don't TELL.
### Response:\n`;

      return p_ll2;
    }

    async function call_llm(rspMsgTextArea=null, p_cgpt="",p_ll2="")
    {
      inf_temp = Number(document.getElementById("inf_temperature").value);
      inf_max_gen = Number(document.getElementById("inf_max_gen").value);
      const aoi_key = document.getElementById("tb_oai_key").value;
      const llmType = document.getElementById("opt_llm").value;
      let rspFull = "";
      if(llmType=="CGPT")
      {
        rspFull = await window.call_ai.call_oai_completion_stream("", p_cgpt, aoi_key, rspMsgTextArea, inf_temp, inf_max_gen)
      }
      else
      {
        rspFull = await window.call_ai.call_ll2_completion(p_ll2, [], rspMsgTextArea, inf_temp, inf_max_gen);
      }

      return rspFull;
    }
    
    async function generateStoryPlotPoint()
    {
      let p_cgpt = getPromptExpandPlotline("CGPT");
      let p_ll2 = getPromptExpandPlotline("LL2_CHAT");
      const rspMsgTextArea = document.getElementById("ta_gen_storyplotpoint_result");
      rspMsgTextArea.value = "";

      //alert(p_ll2);return;

      let rspFull = await call_llm(rspMsgTextArea, p_cgpt, p_ll2)
      // Update rspMsgTextArea
      rspMsgTextArea.value = rspFull.trim();
      alert("Plot Point Expander: Finished");
    }


    async function continueStoryPlotPoint()
    {
      const rspMsgTextArea = document.getElementById("ta_gen_storyplotpoint_result");
      const lastRsp = rspMsgTextArea.value;
      let p_cgpt =`${getPromptExpandPlotline("CGPT")}${lastRsp}`;
      let p_ll2 = `${getPromptExpandPlotline("LL2_CHAT")}${lastRsp}`;


      let rspFull = await call_llm(rspMsgTextArea, p_cgpt, p_ll2)
      // Update rspMsgTextArea
      rspMsgTextArea.value = `${lastRsp} ${rspFull}`;
      alert("Plot Point Expander: Finished");
    }


    async function generateStoryPlotline()
    {
      let p_cgpt = getPromptPlotline("CGPT");
      let p_ll2 = getPromptPlotline("LL2_CHAT");

      const rspMsgTextArea = document.getElementById("ta_gen_storyplotline_result");
      rspMsgTextArea.value = "";
      let rspFull = await call_llm(rspMsgTextArea, p_cgpt, p_ll2)
      // Update rspMsgTextArea
      rspMsgTextArea.value = rspFull.trim();
      alert("Plot Lines Generator: Finished");
    }


    async function continueStoryPlotline()
    {
      const rspMsgTextArea = document.getElementById("ta_gen_storyplotline_result");
      const lastRsp = rspMsgTextArea.value;
      const p_template = `${getStorySetupPrompt()}\n\n${lastRsp}`;

      let rspFull = await call_llm(rspMsgTextArea, p_template, p_template)
      // Update rspMsgTextArea
      rspMsgTextArea.value = `${lastRsp} ${rspFull}`;
      alert("Plot Lines Generator: Finished");
    }

  </script>


  <!-- Layout -->
  <script type="module">
    const wnd_settings = new WinBox({
    title: "Settings",
    class: "dark no-max no-full no-close no-resize",
    _x: "left",
    _y: "top",
    width: "15%",
    height: "50%",
    html: `
        <div class="" style="margin_:0.9em;">
          <div class="row mb-3" style="color:white;">  
            <label for="tb_oai_key">OAI Key</label>
            <input type="password" id="tb_oai_key" value="xxxx" style="">
          </div>
          <div class="row mb-3" style="color:white">  
            <label >JSON Data</label>
            <div class="_hstack">
              <label for="file_import_json" class="button-label">Import</label>
            <input type="file" id="file_import_json" accept=".json" style="display: none;">       
            
            <label class="button-label" onclick="jsonDataExport()">Export</label>
            </div>
            
          </div>

          <div class="row mb-3">
            <label for="opt_llm">LLM Type</label>
            <select id="opt_llm">
              <option value="CGPT">OAI ChatGPT-3.5-turbo</option>
              <option value="LL2">LLC LLama2-Chat</option>
            </select>
          </div>

          <div class="row mb-3">
            <input style="width:4em;" type="numeric" id="inf_temperature" value="0.7" title="Geneneration Temperature">
            <input style="width:4em;" type="numeric" id="inf_max_gen" value="256" title="Max.Geneneration">
          </div>
        </div>
`
    });
    
    const wnd_storySetup = new WinBox({
    title: "Step 1: Story Setup",
    class: "dark no-max no-full no-close",
    min: false,
    x: "center",
    y: "center",
    width: "20%",
    height: "40%",
    html: `
        <div style="padding:1em;">
          <div class="mb-3 hstack" style="color:white">  
                <label style="width:30%;" >Story Genres</label>
                <input style="width:70%;" type="text" id="tb_gen_storyplotline_genres" value="teen adult horror">
              </div>
              
              <div class="mb-3 hstack" style="color:white">  
                <label style="width:30%;" >Time Period</label>
                <input style="width:70%;" type="text" id="tb_gen_storyplotline_timeperiod" value="modern">
              </div>

              <div class="mb-3 hstack" style="color:white">    
                <label style="width:30%;">Locations</label>
                <input style="width:70%;" type="text" id="tb_gen_storyplotline_locations" value="new york">
              </div>

              <div class="mb-3" style="width:100%;"> 
                <label">Additional Notes</label>
                <textarea style="width:100%;" id="ta_gen_storyplotline_initial_premise" rows="5">The MFC is a vampire.</textarea>
              </div>
        </div>        
      `
    });

    const wnd_gen_storyPlotline = new WinBox({
    title: "Step 2: Generate Story Plot Line",
    class: "dark no-max no-full no-close",
    min: true,
    x: "center",
    y: "center",
    width: "40%",
    height: "60%",
    html: `
        <div style="padding:1em;">
          <div class="mb-3" style="">    
            <button class="btn btn-primary" id="btn_gen_storyplotline_generate" onclick="generateStoryPlotline()">Generate</button>
            <button class="btn btn-primary" id="btn_gen_storyplotline_continue" onclick="continueStoryPlotline()">Continue</button>
          </div>
          <textarea style="width:100%;height:80%;overflow-x:scroll;" id="ta_gen_storyplotline_result"></textarea>
        </div>
      `
    });

    const wnd_expand_storyPlotline = new WinBox({
    title: "Step 3: Expand Story Plot Point",
    class: "dark no-max no-full no-close",
    min: true,
    x: "center",
    y: "center",
    width: "40%",
    height: "60%",
    html: `
        <div style="padding:1em;">
          <div class="mb-3">
            <label>Plot Point To Expand</label>
            <textarea style="width:100%;height:20%" id="ta_gen_storyplotpoint_source"></textarea>
          </div>
          <div class="mb-3" style="">    
            <button class="btn btn-primary" id="btn_gen_storyplotpoint_expand" onclick="generateStoryPlotPoint()">Expand</button>
            <button class="btn btn-primary" id="btn_gen_storyplotpoint_continue" onclick="continueStoryPlotPoint()">Continue</button>
            <input style="width:7em;" type="text" id="tb_gen_storyplotpoint_style" value="dark noir" title="Story telling style">
          </div>

          <label>Expanded Plot Point</label>
          <textarea style="width:100%;height:80%" id="ta_gen_storyplotpoint_result"></textarea>
        </div>
      `
    });


    
    $(window).load(async function() {
      window.wnd_storySetup = wnd_storySetup;
      window.wnd_gen_storyPlotline = wnd_gen_storyPlotline;
      window.wnd_expand_storyPlotline = wnd_expand_storyPlotline;

      const tb_oai_key = $("#tb_oai_key")[0];
      tb_oai_key.value = my_oaiKey??"";

      const file_import_json = document.getElementById('file_import_json');
      file_import_json.addEventListener('change',jsonDataImport);
    });
  </script>
</body>
</html>